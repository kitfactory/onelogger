# onelogger 仕様書
## 1. はじめに
### 1.1. 概要
onelogger は、Python の標準ライブラリである logging をベースに、oneenv による環境変数管理を利用して動的に設定を変更可能なロギングシステムです。picologging を利用して、非常に高速なログを実現するとともに、ログの出力形式を柔軟に変更可能なロギングシステムです。
本仕様書は、onelogger の設計方針、機能、設定項目、実装例、ならびに運用上の注意事項を記述しています。

### 1.2. 背景・目的
背景:
アプリケーションの運用やデバッグにおいて、柔軟なログ設定が必要です。環境ごとに異なるログレベルや出力先、フォーマットを容易に切り替えられる仕組みが求められています。

目的:
oneenv を利用して環境変数から設定を一元管理することで、開発・本番環境でのログ出力の振る舞いをシンプルかつ柔軟に制御できる Logger を実現する。

### 1.3. 利用ライブラリ・技術
picologging モジュール
oneenv
環境変数を手軽に取得するためのライブラリ

## 2. 基本設計
### 2.1. oneenv との統合
oneenv.get() を利用して、環境変数からログに関する設定（ログレベル、出力先、フォーマットなど）を取得。
各種設定項目は環境変数により動的に変更可能とする。

### 2.2. ロガーの基本構造と階層
ロガーの階層構造:
ロガーは名前空間に基づいて階層化され、例として myapp（親ロガー）と myapp.module（子ロガー）などの構造が想定される。

### メリットと注意点:
メリット: 複数モジュール間で共通のログ処理（例：中央集約型のログ出力）が可能となる。
注意点: 子ロガーと親ロガーの双方にハンドラーが設定されている場合、同一のログが重複して出力される可能性があるため、必要に応じて propagate=False を設定する。

## 3. 機能要件
### 3.1. ログレベル設定
設定項目:
ログレベル（例: DEBUG, INFO, WARNING, ERROR, CRITICAL）
目的:
出力するログの詳細度を制御し、必要な情報のみ抽出する。

### 3.2. 出力先設定
設定項目:
出力先（例: console, file, syslog, remote）
ファイル出力の場合のファイルパス
目的:
ログをどこに出力するかを柔軟に設定できるようにする。

### 3.3. ログフォーマット設定
設定項目:
ログフォーマット（例: plain（プレーンテキスト）、json（構造化ログ）、カスタムフォーマット）
タイムスタンプのフォーマット（例: ISO 8601 や %Y-%m-%d %H:%M:%S）
目的:
ログの出力形式を統一し、後処理や解析ツールとの連携を容易にする。

### 3.4. ログファイル管理
ローテーション:
タイプ：日付/サイズ
最大ファイルサイズ（例: 10MB）
バックアップファイルの保持数
バッファリングとフラッシュ:
バッファリング時間やフラッシュ間隔の設定
目的:
ディスク容量の管理、古いログの整理、及びパフォーマンス向上を図る。

### 3.5. メタデータ・拡張情報の出力
設定項目:
プロセスID、スレッドID、ホスト名、アプリケーション名、実行環境（development/production など）
目的:
ログのコンテキスト情報を充実させ、トラブルシューティングや監査に役立てる。

### 3.6. 例外トレースの出力
設定項目:
スタックトレースの出力有無
目的:
エラー発生時に詳細な例外情報を出力し、原因解析を支援する。

### 3.7. ハンドラー・フィルター設定
設定項目:
複数ハンドラーの利用（例: コンソールとファイルの併用）
モジュール単位や特定条件に基づくログフィルタリング
目的:
ログの出力先ごとに異なる設定を行い、必要な情報のみを適切な場所に送信する。

### 3.8. 同期/非同期ログ出力設定
設定項目:
非同期ログ出力の有効化（true/false）
目的:
ログ出力のパフォーマンスと信頼性のバランスを調整する。

### 3.9. ロガー名・プロパゲーション設定
設定項目:
ロガー名（名前空間を用いて識別）
伝播 (propagate) の有無
目的:
複数のロガー間で一貫したログ管理を行い、必要な場合にのみログの重複出力を防止する。

## 4. 設定項目一覧 (.env.example形式)
以下は、上記の機能要件に対応する設定項目をまとめた .env.example の例です。


```yaml
# -------------------------------
# OneLogger 設定ファイル (.env.example)
# -------------------------------

# 1. ログレベル設定
# 使用可能な値: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# 2. 出力先設定
# 出力先: console, file, both など
LOG_OUTPUT=console
# 出力先がファイルの場合のファイルパス（ファイル出力を選択時のみ有効）
LOG_FILE_PATH=/var/log/app.log

# 3. ログフォーマット設定
# 使用可能な値: plain, json
LOG_FORMAT=plain

# タイムスタンプのフォーマット例: ISO 8601 や "%Y-%m-%d %H:%M:%S"
LOG_TIMESTAMP_FORMAT=%Y-%m-%d\ %H:%M:%S

# 4. ログファイル管理 (ファイル出力の場合)
# ローテーションタイプ
# 使用可能な値: size, date
LOG_ROTATION_TYPE=size
# ローテーション設定: 最大ファイルサイズ（バイト単位, 例: 10485760 = 10MB）
LOG_MAX_FILE_SIZE=10485760
# バックアップとして保持するログファイルの数
LOG_BACKUP_COUNT=5

# 5. バッファリングとフラッシュ設定
# ログ出力のバッファリング時間（秒単位）
LOG_BUFFER_TIME=1

# 6. メタデータ・拡張情報
# プロセスIDを含める場合は true に設定
LOG_INCLUDE_PID=true
# スレッドIDを含める場合は true に設定
LOG_INCLUDE_THREAD=true
# アプリケーション名（任意）
LOG_APP_NAME=MyApp

# 7. 例外トレース設定
# エラー発生時にスタックトレースをログに含めるかどうか
LOG_STACKTRACE=true

# 8. 同期/非同期ログ設定
# 非同期ログ出力を使用する場合は true に設定
LOG_ASYNC=false
```

## 5. 実装例
#### 使用例

```
from onelogger import Logger

# ロガー名をファイル名から取得、ログはシングルトンパターンでキャッシュ
logger = Logger.get_logger(__file__) 

logger.info("OneLogger is initialized.")
```

## 6. 注意事項
環境変数による設定:
各種設定は環境変数で柔軟に変更可能ですが、実運用前に各項目が意図した通りに動作することを十分にテストする必要があります。

ローテーション・バッファリング:
ログファイルが大きくなりすぎないようにローテーション設定を行い、パフォーマンスに影響がないようにバッファリング・フラッシュ設定を適切に調整してください。

## 7. まとめ
本仕様書では、oneenv を利用して環境変数から動的に設定を取得する onelogger の設計・実装方針を示しました。
主要な機能としては、ログレベル、出力先、フォーマット、ログファイル管理、メタデータ付加、例外トレース、非同期処理、そしてロガーの階層構造におけるログの伝播が含まれています。
これにより、柔軟かつ拡張性の高いロギング機能を提供し、開発・運用環境に応じた最適なログ管理が可能となります。

